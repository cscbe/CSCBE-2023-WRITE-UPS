FROM ubuntu AS builder
RUN uname -a
RUN dpkg --add-architecture i386
#RUN apt-get update && apt-get upgrade -y
RUN apt-get update && apt-get install -y --no-install-recommends make gcc-multilib libc6-dev libssl-dev openssl libssl-dev:i386 libc6-dev:i386

COPY ./ /src
WORKDIR /src

RUN make hutchyyos

FROM ubuntu

USER root

RUN useradd -ms /bin/bash challenge
RUN dpkg --add-architecture i386
RUN apt-get update && apt-get install -y libc6-dev socat libssl-dev libssl-dev:i386 libc6-dev:i386 && rm -rf /var/lib/apt/lists/*


#COPY ./hutchyyos /challenge/challenge 
#COPY ./flag.txt /challenge/
COPY --from=builder /src/hutchyyos /challenge/challenge
COPY --from=builder /src/flag.txt /challenge/
RUN chmod +x /challenge/challenge

USER challenge
WORKDIR /challenge
ENTRYPOINT ["sh", "-c", "socat TCP-LISTEN:5000,reuseaddr,fork EXEC:./challenge"]
