#include <openssl/sha.h>
#include <stdbool.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#define HELP 1
#define ROUTERINFO 2
#define LOGIN 3
#define SUPERADM 4
#define EXIT 99
#define NOT_FLAG "CSC{n0t_th3_fl4g}"

void super_admin_panel(char role) {
    if (role == 's') {
        system("cat flag.txt");
    } else {
        printf("You don't have the rights!\nYou currently have the %c role\n", role);
    }
}

char login() {
    char user[1024] = {0};
    char logged_in_user = 'n';
    printf("[DEBUG] REMOVE FOR PROD!!\nLogged_in_user addr: %p\n", &logged_in_user);
    char password[64] = {0};
    printf("Username: ");
    scanf("%1023s", user);
    printf("Password: ");
    scanf("%63s", password);
    unsigned char hexdigest[SHA512_DIGEST_LENGTH * 2 + 1];
    unsigned char hash[SHA512_DIGEST_LENGTH];
    SHA512(password, sizeof(password) - 1, hash);
    int j = 0;
    for (int i = 0; i < SHA512_DIGEST_LENGTH; i++) {
        sprintf(&hexdigest[j], "%02x", hash[i]);
        j += 2;
    }
    // printf("%s\n", hexdigest);
    if (strcmp(user, "Admin") == 0) {
        if (strcmp(hexdigest, "f0783ee265918eb13aff7bb616b2daf91589eb3ef65149e7c2f762d77b85776e41ed307c87a1dd196ba8836066eb66bc4efce4db9074d36bd1d8db970576a401") == 0) {
            printf("You are now logged in as %s", user);
            logged_in_user = 'a';
        } else {
            printf("Wrong password for %s", user);
        }
    } else if (strcmp(user, "Guest") == 0) {
        if (strcmp(hexdigest, "9c15fb8df5a753731681c75f942c2c69ad702ce124b8a0df522df498b4129fd633fb666a22089ce10d122b4c0aff29ad75c56b33903c77b1d9ac6f197aa45b00") == 0) {
            printf("You are now logged in as %s", user);
            logged_in_user = 'g';
        } else {
            printf("Wrong password for %s", user);
        }
    } else {
        printf("The user ");
        printf(user);
        printf(" doesn't exist!\n");
    }
    return logged_in_user;
}

void router_info(char role) {
    bool authorized = true;
    if (role == 'a') {
        authorized = false;
    }

    printf("          Router brand: Fancy\n");
    printf("      Router public IP: 0.0.0.0\n");
    printf("Router available roles: Super Admin, Admin, Guest\n");
    if (authorized) {
        printf(" Router Admin password: *****\n");
    } else {
        printf("Router Admin password: login as admin or guest to view this");
    }
    printf(" Router Guest password: *\n");
    printf("          Current role: %c\n", role);
}

void help(char role) {
    printf("\n******************* HELP MENU **********************\n");
    printf("* Available commands                                *\n");
    printf("* -------------------                               *\n");
    printf("* Help - print this                                 *\n");
    printf("* Routerinfo - show router's current information    *\n");
    printf("* Login - login to access sensitive functions       *\n");
    if (role == 's') {
        printf("* Super admin - access to super admin functions     *\n");
    }
    printf("* Exit - quit this program                          *\n");
    printf("*****************************************************\n\n");
}

void print_menu(char role) {
    printf("\n\n***** WELCOME TO ROUTER OS **************\n");
    printf("* Available commands                    *\n");
    printf("* -------------------                   *\n");
    printf("* %d. Help                               *\n", HELP);
    printf("* %d. Routerinfo                         *\n", ROUTERINFO);
    printf("* %d. Login                              *\n", LOGIN);
    if (role == 's') {
        printf("* %d. Super admin panel                  *\n", SUPERADM);
    }
    printf("* %d. Exit                               *\n", EXIT);

    printf("*****************************************\n");
    printf("Ro> ");
}

void main() {
    char logged_in = 'n';
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    int command;
    char choice[3];
    char *endp;
    print_menu(logged_in);
    scanf("%2s", &choice);
    command = strtol(choice, &endp, 10);
    while (command != EXIT) {
        switch (command) {
            case HELP:
                help(logged_in);
                break;
            case ROUTERINFO:
                router_info(logged_in);
                break;
            case LOGIN:
                logged_in = login();
                break;
            case SUPERADM:
                super_admin_panel(logged_in);
                break;
            default:
                printf("Wrong command number entered");
                break;
        }
        print_menu(logged_in);
        scanf("%1s", &choice);
        command = strtol(choice, &endp, 10);
    }

    printf("Goodbye!\n");
    // shell();
    return 0;
}
